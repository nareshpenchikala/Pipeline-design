name: Deploy app - Production

on:
  release:
    types:
      - created
    paths:
      - "folder_2/internal_folder_2/**"
      - "folder_1/**"
      - "tailwindts.txt"
      - "packagejason.txt"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 5

    - name: get previous tag
      id: last_tag
      run: |
        echo "previous_tag=$(git describe --tags --abbrev=0 HEAD^)" >> $GITHUB_OUTPUT

    - name: set application name based on changes
      id: set application
      run: |
        DIFF=$(git diff --name-only ${{ steps.last_tag.outputs.previous_tag }} HEAD) echo "$DIFF" > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "21"

    - name: Install Helm
      run: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh

    - name: Install AWS CLI v2
      run: |
        sudo apt-get update && sudo apt-get install -y unzip
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install --update
