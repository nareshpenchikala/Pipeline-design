name: Deploy app - Production

on:
  release:
    types:
      - created

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 5

    - name: Get previous tag (corrected)
      id: tags
      run: |
        current_tag="${{ github.event.release.tag_name }}"
        previous_tag=$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags | grep -v "^$current_tag$" | head -n 1)
    
        echo "Current tag: $current_tag"
        echo "Previous tag: $previous_tag"
    
        echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT

    - name: Show file changes between releases
      run: |
        echo "Files changed between ${{ steps.tags.outputs.previous_tag }} and ${{ github.event.release.tag_name }}:"
        git diff --name-only 0.5.0 -- ${{ github.event.release.tag_name }} > changed_files.txt
        cat changed_files.txt

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "21"

    - name: Install Helm
      run: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh

    - name: Install AWS CLI v2
      run: |
        sudo apt-get update && sudo apt-get install -y unzip
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install --update
